<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebelus API Client - Voice & Translation</title>

    <!-- Tailwind CSS Play CDN (alternative to main CDN) -->
    <script src="https://unpkg.com/tailwindcss-cdn@3.4.3/tailwindcss.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 p-5">
    <!--
    ============================================
    NEBELUS API CLIENT - VOICE & TRANSLATION
    ============================================
    
    This example demonstrates how to connect to the Nebelus API for real-time voice conversations and translation.
    
    QUICK START:
    ------------
    1. Open this file in a browser (must be served over HTTPS or HTTP)
    2. Enter your API key (sk-ns-org-...)
    3. Click "Connect"
    4. Click "Start Translation" to begin streaming audio
    
    CODE SNIPPETS:
    --------------
    
    ## Connect to WebSocket with API Key
    ```javascript
    const apiKey = 'sk-ns-org-your-api-key';
    const wsUrl = `wss://api.nebelus.ai/stream/?api_key=${encodeURIComponent(apiKey)}`;
    const socket = new WebSocket(wsUrl);
    
    socket.onopen = () => {
        console.log('Connected!');
    };
    
    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('Event:', data.event, data.content);
    };
    ```
    
    ## Send Events
    ```javascript
    function sendEvent(event, data) {
        const message = { event, ...data };
        socket.send(JSON.stringify(message));
    }
    
    // Start translation session
    sendEvent('TRANSLATION_SESSION_START', {
        language_a: 'en',
        language_b: 'es',
        enable_tts: true
    });
    
    // Send audio stream
    sendEvent('TRANSLATION_AUDIO_STREAM', {
        session_id: sessionId,
        audio_data: base64AudioData  // 16kHz, Int16, mono, PCM
    });
    
    // Update settings
    sendEvent('TRANSLATION_SETTINGS_UPDATE', {
        session_id: sessionId,
        language_a: 'fr',
        language_b: 'de'
    });
    
    // End session
    sendEvent('TRANSLATION_SESSION_END', {
        session_id: sessionId
    });
    ```
    
    ## Receive Events
    ```javascript
    switch (data.event) {
        case 'TRANSLATION_SESSION_START':
            // Server created session, use content.session_id for future requests
            console.log('Session ID:', content.session_id);
            break;
            
        case 'TRANSLATION_RESULT':
            console.log('Original:', content.original_text);
            console.log('Translation:', content.translated_text);
            console.log('Confidence:', content.confidence);
            break;
            
        case 'VOICE_SESSION_CREATED':
            console.log('Voice session:', content.session_id);
            break;
            
        case 'VOICE_TURN_END':
            console.log('Transcription:', content.text);
            console.log('Language:', content.language);
            break;
            
        case 'VOICE_OUTPUT_AUDIO':
            // Decode Base64 audio and play
            const audioBytes = Uint8Array.from(atob(content.audio_data), c => c.charCodeAt(0));
            const audioBlob = new Blob([audioBytes], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();
            break;
    }
    ```
    
    ## Audio Format
    - Sample Rate: 16000 Hz
    - Format: PCM Int16 (little-endian)
    - Channels: Mono (1 channel)
    - Encoding: Base64
    
    AUTHENTICATION:
    ---------------
    Use API Key authentication in the WebSocket URL:
    wss://api.nebelus.ai/stream/?api_key=sk-ns-org-your-key-here
    
    For local development:
    ws://127.0.0.1:8000/stream/?api_key=sk-ns-org-your-key-here
    
    FULL DOCUMENTATION:
    -------------------
    See readme.md for complete API reference and event documentation.
    ============================================
    -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 text-center md:text-left">
        <div class="flex items-center justify-center md:justify-start gap-4 mb-2">
          <img src="https://storage.googleapis.com/nebelus-public/logo.png" alt="Nebelus Logo" class="h-12 w-auto" />
          <h1 class="text-3xl font-bold">Nebelus API Client</h1>
        </div>
        <p class="opacity-90">Real-time Voice & Translation</p>
      </div>

      <div class="p-8">
        <!-- Connection Section -->
        <div class="mb-8">
          <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Connection</h2>
          <div class="mb-5">
            <label class="block mb-2 text-gray-700 font-medium" for="apiUrl" class="block mb-2 text-gray-700 font-medium"
              >API Base URL</label
            >
            <input
              type="text"
              class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
              id="apiUrl"
              value="wss://api.nebelus.ai"
              placeholder="wss://api.nebelus.ai or ws://127.0.0.1:8000" />
          </div>
          <div class="mb-5">
            <label class="block mb-2 text-gray-700 font-medium" for="authToken">API Key <span class="text-red-600">*</span></label>
            <input
              type="password"
              class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
              id="authToken"
              placeholder="Enter API key (sk-ns-org-...)"
              required />
            <small class="block mt-1.5 text-gray-500 text-xs">
              Required. API key (sk-ns-org-...) in URL query parameter. Works in all browsers.
            </small>
          </div>
          <div class="mb-5">
            <label for="agentId" class="block mb-2 text-gray-700 font-medium">Agent ID <span class="text-red-600">*</span></label>
            <input
              type="text"
              id="agentId"
              placeholder="Enter agent UUID (e.g., 550e8400-e29b-41d4-a716-446655440000)"
              class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
              required />
            <small class="block mt-1.5 text-gray-500 text-xs"> Required. The UUID of the AI agent you want to converse with. </small>
          </div>
          <div id="connectionStatus" class="p-4 rounded-lg mb-5 font-medium bg-red-100 text-red-800 border-2 border-red-500">
            ‚ö´ Disconnected
          </div>
          <div class="flex gap-2.5 flex-wrap">
            <button
              id="connectBtn"
              onclick="connect()"
              class="px-6 py-3 rounded-lg text-sm font-semibold cursor-pointer transition-all bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:-translate-y-0.5 hover:shadow-lg">
              Connect
            </button>
            <button
              id="disconnectBtn"
              onclick="disconnect()"
              disabled
              class="px-6 py-3 rounded-lg text-sm font-semibold cursor-pointer transition-all bg-gray-600 text-white opacity-50 cursor-not-allowed">
              Disconnect
            </button>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
          <nav class="flex gap-4" role="tablist">
            <button
              onclick="switchTab('translation')"
              id="tab-translation"
              class="tab-button px-6 py-3 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600 bg-indigo-50 rounded-t-lg"
              role="tab"
              aria-selected="true">
              üåê Translation
            </button>
            <button
              onclick="switchTab('voice')"
              id="tab-voice"
              class="tab-button px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300"
              role="tab"
              aria-selected="false">
              üé§ Voice Conversation
            </button>
          </nav>
        </div>

        <!-- Tab Content: Translation -->
        <div id="content-translation" class="tab-content bg-indigo-50 p-6 rounded-lg border-2 border-indigo-100">
          <!-- Settings Section -->
          <div class="mb-8">
            <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Translation Settings</h2>
            <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-4">
              <div class="mb-5">
                <label class="block mb-2 text-gray-700 font-medium" for="languageA">Source Language</label>
                <select
                  class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
                  id="languageA">
                  <option value="en" selected>English</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                  <option value="ar">Arabic</option>
                  <option value="zh">Chinese</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                </select>
              </div>
              <div class="mb-5">
                <label class="block mb-2 text-gray-700 font-medium" for="languageB">Target Language</label>
                <select
                  class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
                  id="languageB">
                  <option value="en">English</option>
                  <option value="es" selected>Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                  <option value="ar">Arabic</option>
                  <option value="zh">Chinese</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                </select>
              </div>
            </div>
            <div class="mb-5">
              <label class="block mb-2 text-gray-700 font-medium" for="context">Context (Optional)</label>
              <textarea
                class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-600 transition-colors"
                id="context"
                rows="2"
                placeholder="e.g., Medical terminology, business meeting..."></textarea>
            </div>

            <!-- TTS Toggle Switch -->
            <div class="mb-5">
              <div
                class="inline-flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
                <div class="flex-1">
                  <label
                    class="block mb-2 text-gray-700 font-medium"
                    for="enableTts"
                    class="block font-medium text-sm text-gray-900 dark:text-white cursor-pointer"
                    >Enable Text-to-Speech</label
                  >
                  <p class="text-xs text-gray-500 dark:text-gray-400">Play translated audio</p>
                </div>
                <button
                  type="button"
                  id="ttsToggle"
                  onclick="toggleTTS()"
                  class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 bg-gray-200"
                  role="switch"
                  aria-checked="false">
                  <span class="sr-only">Enable TTS</span>
                  <span
                    id="ttsToggleThumb"
                    class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                </button>
              </div>
              <input type="checkbox" id="enableTts" class="hidden" />
            </div>

            <div class="flex gap-2.5 flex-wrap">
              <button
                id="updateSettingsBtn"
                class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:-translate-y-0.5 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="updateSettings()"
                disabled>
                Update Settings
              </button>
            </div>
          </div>

          <!-- Session Control -->
          <div class="mb-8">
            <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Session Control</h2>
            <div class="flex gap-2.5 flex-wrap">
              <button
                id="startBtn"
                class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-green-500 text-white hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="startTranslation()"
                disabled>
                Start Translation
              </button>
              <button
                id="stopBtn"
                class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-red-500 text-white hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="stopTranslation()"
                disabled>
                End Translation
              </button>
            </div>
            <div class="flex gap-5 flex-wrap mt-5">
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="sessionDuration">00:00</div>
                <div class="text-xs text-gray-600 mt-1">Session Duration</div>
              </div>
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="translationCount">0</div>
                <div class="text-xs text-gray-600 mt-1">Translations</div>
              </div>
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="audioChunks">0</div>
                <div class="text-xs text-gray-600 mt-1">Audio Chunks Sent</div>
              </div>
            </div>
          </div>

          <!-- Translations Display -->
          <div class="mb-8">
            <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Translation Results</h2>
            <div id="translations" class="max-h-96 overflow-y-auto border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
              <p class="text-center text-gray-400 p-5">No translations yet. Start a session to see results here.</p>
            </div>
          </div>
        </div>

        <!-- Tab Content: Voice Conversation -->
        <div id="content-voice" class="tab-content hidden">
          <!-- Voice Conversation -->
          <div class="mb-8">
            <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Voice Conversation (AI Agent)</h2>

            <div id="voiceState" class="p-4 rounded-lg mb-4 font-medium bg-red-100 text-red-800 border-2 border-red-500">
              ‚ö´ No active voice session
            </div>

            <div class="flex gap-2.5 flex-wrap mb-4">
              <button
                id="startVoiceBtn"
                class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-blue-500 text-white hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="startVoiceConversation()"
                disabled>
                üé§ Start Voice Conversation
              </button>
              <button
                id="stopVoiceBtn"
                class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-red-500 text-white hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="stopVoiceConversation()"
                disabled>
                ‚èπÔ∏è Stop Voice Conversation
              </button>
            </div>

            <div class="flex gap-5 flex-wrap">
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="voiceSessionId">-</div>
                <div class="text-xs text-gray-600 mt-1">Session ID</div>
              </div>
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="voiceTurns">0</div>
                <div class="text-xs text-gray-600 mt-1">Voice Turns</div>
              </div>
              <div class="flex-1 min-w-[150px] p-4 bg-gray-50 rounded-lg text-center">
                <div class="text-2xl font-bold text-indigo-600" id="voiceMessages">0</div>
                <div class="text-xs text-gray-600 mt-1">Messages Created</div>
              </div>
            </div>
          </div>

          <!-- Voice Events Display -->
          <div class="mb-8">
            <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-indigo-600 pb-3 font-semibold">Voice Conversation Events</h2>
            <div id="voiceEvents" class="max-h-96 overflow-y-auto border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
              <p class="text-center text-gray-400 p-5">No voice events yet. Start a voice conversation to see events here.</p>
            </div>
          </div>
        </div>

        <!-- Event Log (Always Visible) -->
        <div class="mb-8 mt-8 pt-8 border-t-2 border-gray-200">
          <h2 class="text-gray-800 mb-4 text-xl border-b-2 border-gray-400 pb-3 font-semibold">üìã Debug Event Log</h2>
          <div
            id="eventLog"
            class="bg-gray-800 text-green-500 p-4 rounded-lg font-mono text-xs max-h-80 overflow-y-auto whitespace-pre-wrap break-words"></div>
          <div class="flex gap-2.5 flex-wrap mt-2.5">
            <button
              class="px-6 py-3 rounded-lg text-sm font-semibold transition-all bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
              onclick="clearLog()">
              Clear Log
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="app.js"></script>
  </body>
</html>
